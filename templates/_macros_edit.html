{% from '_macros_lists.html' import doc_list, family_list, person_list  %}

{% macro edit_doc(document_types,  flags={}, document = {}) -%}

{% set document_id = 0 if flags.document == 'create_document' else document['document.id'] %}
{{ flags }}

<h1> Документ </h1>
<form method="post" id="general">
        <input type="hidden"  name="action" value="{{ flags.document }}" />
        <input type="hidden"  name="{{ flags.document }}" value="{{ document_id }}" />

        <div>
                <label for="type_id" class="form-label">Тип документа:</label>
                <select name = "type_id" selected ="{{ document['document_type.name'] }}">
                        {% for t in document_types %}
                        <option value="{{ t['document_type.id'] }}" 
                                {% if flags.document != 'create_document' and t['document_type.id']==document['document.type_id'] %} 
                                        selected="selected" 
                                {% endif %}> 
                        {{ t['document_type.name'] }}  
                        </option>
                        {% endfor %}
                </select>
        </div>
        <div>
                <label for="lastname" class="form-label">Наименование:</label>
                <input type="text"  name="name" value = "{{ document['document.name'] }}">

                <label for="series" class="form-label">Серия:</label>
                <input type="text"  name="series" value = "{{ document['document.series'] }}">

                <label for="number" class="form-label">Номер:</label>
                <input type="text"  name="number"  value = "{{ document['document.number'] }}">
        </div>
        <div><label for="issuer" class="form-label">Выдан:</label></div>
        <div><textarea name = "issuer" rows = 2 cols = 100>{{ document['document.issuer'] }}</textarea> </div>
        <div>
                <label for="issue_date" class="form-label">Дата выдачи:</label> 
                <input type="date"  name="issue_date" value = "{{ document['document.issue_date'] }}">
        </div>
        <div><label for="comment" class="form-label">Комментарий:</label> </div>
        <div><textarea name = "comment" rows = 2 cols = 100>{{ document['document.comment'] }}</textarea></div>
        <div><label for="attributes" class="form-label">Атрибуты:</label> </div>
        <div><textarea name = "attributes" rows = 2 cols = 100>{{ document['document.attributes'] }}</textarea> </div>
        <input type="submit"></button>
</form>


{%- endmacro %}

{% macro edit_person(flags={}, context = {}) -%}

{% set person = {} if flags.person == 'create_person' else context.person %}
{% set person_id = 0 if flags.person == 'create_person' else person['person.id'] %}
<h1> Персональные данные </h1>
<form method="post" id="general">
        {% if flags.person!="edit_person" and flags.person!="create_person" %} <fieldset disabled> {% endif %}
        <input type="hidden"  name="action" value="{{ flags.person }}" />
        <input type="hidden"  name="{{ flags.person }}" value="{{ person_id }}" />

        <label for="lastname" class="form-label">Фамилия:</label>
        <input type="text"  name="lastname" value = "{% if flags.person!=create_person %}{{ person['person.lastname'] }}{% endif %}">

        <label for="firstname" class="form-label">Имя:</label>
        <input type="text"  name="firstname" value = "{% if flags.person!=create_person %}{{ person['person.firstname'] }}{% endif %}">

        <label for="secondname" class="form-label">Отчество:</label>
        <input type="text"  name="secondname"  value = "{% if flags.person!=create_person %}{{ person['person.secondname'] }}{% endif %}">

        <label for="birthdate" class="form-label">Дата рождения:</label>
        <input type="date"  name="birthdate" value = "{% if flags.person!=create_person %}{{ person['person.birthdate'] }}{% endif %}">
        
        {% if flags.family == "edit_family" %}
        <label for="role" class="form-label">Роль:</label>
        <input type="text"  name="role" value = "{% if flags.person!=create_person %}{{ person['family_person.role'] }}{% endif %}">
        {% endif %}

        <input type="submit"></button>
        {% if flags.person!="edit_person" %} </fieldset> {% endif %}
</form>

{% if flags.person!='create_person' %}

<h1> Документ удостоверяющий личность </h1>

{% if person['person.passport_id'] == 0 %}

<div> Не обнаружен. </div>

{% else %}

<div> Тип: {{ person['passport_type.name'] }} </div>
<div> Серия: {{ person['passport.series'] }} </div>
<div> Номер: {{ person['passport.number'] }} </div>
<div> Выдан: {{ person['passport.issuer'] }} </div>
<div> Дата выдачи: {{ person['passport.issue_date'] }} </div>

{% endif %}

{% set ref = ""%}
{% if flags.family=="edit_family" %}
{% set ref = "edit_person=" + person['person.id']|string %}
{% endif %}

<h1> Документы </h1>
{{ doc_list(context.documents, flags, ref) }}

{% if 'document' not in flags %}

<input type="button" value="Добавить существующий документ" onclick="location.href='?{{ ref }}&add_document';"> 
<input type="button" value="Добавить новый документ" onclick="location.href='?{{ ref }}&create_document';">

{% else %}

<input type="button" value="Отмена" onclick="location.href='?{{ ref }}';"> 

{% endif %}

{% if flags.document=="add_document" %}

{{ doc_list(context.all_document, flags) }}
{% endif %}

{% if flags.document=="create_document" %}
{{ edit_doc(context.document_types, flags) }}
{% endif %}

{% if flags.document=="edit_document" %}
{{ edit_doc(context.document_types, flags, context.document_to_edit) }}
{% endif %}

{% if flags.family!="edit_family" %}
<h1> Список связанных групп заявителей </h1>
{{ family_list(flag='', families=context.linked_families) }}
{% endif %}
{% endif %}
{%- endmacro %}